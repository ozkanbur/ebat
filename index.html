<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e293b">
    <title>Tomruk Stok Pro v3.7</title>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%2315803d' d='M50 10 L10 90 H90 Z' /%3E%3Crect fill='%2378350f' x='40' y='85' width='20' height='15' /%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color: white;'%3E%3Cpath fill='%2315803d' d='M50 10 L10 90 H90 Z' /%3E%3Crect fill='%2378350f' x='40' y='85' width='20' height='15' /%3E%3C/svg%3E">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e293b;
            --accent: #2563eb; 
            --accent-light: #eff6ff;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --border: #cbd5e1;
            --bg: #f1f5f9;
            --header-bg: #f8fafc;
            --tab-active-bg: #2563eb;
            --tab-inactive-bg: #e2e8f0;
            --tab-incomplete-bg: #fffbeb;
            --cloud-btn: #0ea5e9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        
        body { 
            background: var(--bg); 
            height: 100vh;
            height: 100dvh; 
            display: flex; 
            flex-direction: column;
            overflow: hidden; 
            padding-top: env(safe-area-inset-top);
        }

        /* --- APP HEADER --- */
        #app-header {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* --- Gƒ∞Rƒ∞≈û EKRANI --- */
        #upload-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .upload-box {
            background: white; padding: 30px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center;
            border: 1px solid var(--border); max-width: 400px; width: 90%;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        
        .btn-upload-local {
            background: var(--primary); color: white; padding: 14px 24px;
            border-radius: 10px; font-weight: 600; cursor: pointer;
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; border: none; font-size: 0.95rem;
        }
        
        .btn-upload-cloud {
            background: var(--cloud-btn); color: white; padding: 14px 24px;
            border-radius: 10px; font-weight: 600; cursor: pointer;
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; border: none; font-size: 0.95rem;
        }
        
        .btn-upload-local:hover, .btn-upload-cloud:hover { transform: translateY(-2px); filter: brightness(1.1); }

        #btn-restore {
            background: #fff; border: 2px solid var(--success); color: var(--success);
            padding: 12px 24px; border-radius: 10px; font-weight: 700; cursor: pointer;
            width: 100%; display: none; align-items: center; justify-content: center; gap: 8px;
        }

        /* --- CLOUD MODAL --- */
        #cloud-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 10000;
            display: none; align-items: center; justify-content: center;
        }
        .cloud-content {
            background: white; width: 90%; max-width: 500px; height: 85vh;
            border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .cloud-header {
            padding: 15px; background: var(--header-bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .cloud-title { font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 5px; flex: 1; overflow: hidden;}
        .cloud-title span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; margin-left: 10px;}
        
        #cloud-search-area {
            padding: 10px; background: white; border-bottom: 1px solid #eee; display: none;
        }
        #search-input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1;
            font-size: 1rem; background: #f8fafc; outline: none; transition: 0.2s;
        }
        #search-input:focus { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        .cloud-body { flex: 1; overflow-y: auto; padding: 10px; }
        
        .cloud-item {
            padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s; border-radius: 8px;
        }
        .cloud-item:hover { background: #f0f9ff; }
        .cloud-icon { font-size: 1.4rem; min-width: 30px; text-align: center; }
        .cloud-text { font-weight: 500; color: #334155; word-break: break-word;}
        
        /* ƒ∞KON RENKLERƒ∞ */
        .icon-folder { color: #eab308; } /* Sarƒ± Klas√∂r */
        .icon-file { color: #16a34a; }   /* Ye≈üil Excel */
        
        .cloud-loading { text-align: center; padding: 20px; color: #64748b; display: none; }
        .btn-back-cloud { padding: 5px 10px; background: #e2e8f0; border-radius: 5px; cursor: pointer; border: none; font-size: 0.8rem; margin-right: 10px; display: none;}

        /* --- ARA√á Bƒ∞LGƒ∞Sƒ∞ MODAL --- */
        #truck-info-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10001;
            display: none; align-items: center; justify-content: center;
        }
        .truck-info-content {
            background: white; width: 90%; max-width: 400px;
            border-radius: 12px; padding: 25px; animation: slideUp 0.3s ease;
        }
        .truck-info-title {
            font-size: 1.3rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; text-align: center;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-label {
            display: block; font-weight: 600; color: #475569; margin-bottom: 5px; font-size: 0.9rem;
        }
        .input-field {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; outline: none; transition: 0.2s;
        }
        .input-field:focus {
            border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .input-field.error {
            border-color: var(--danger); background: #fef2f2;
        }
        .btn-group {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .btn-cancel {
            flex: 1; padding: 12px; background: #f1f5f9; color: #64748b; border: 1px solid var(--border);
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-save {
            flex: 1; padding: 12px; background: var(--success); color: white;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; border: none;
        }
        .btn-cancel:hover { background: #e2e8f0; }
        .btn-save:hover { background: #15803d; }

        /* --- EXPORT MODAL --- */
        #export-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10001;
            display: none; align-items: center; justify-content: center;
        }
        .export-content {
            background: white; width: 90%; max-width: 450px;
            border-radius: 12px; padding: 25px; animation: slideUp 0.3s ease;
        }
        .export-title {
            font-size: 1.3rem; font-weight: 700; color: var(--primary); 
            margin-bottom: 20px; text-align: center;
        }
        .checkbox-group {
            display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;
            padding: 15px; background: #f8fafc; border-radius: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            margin-top: 3px; width: 18px; height: 18px; cursor: pointer;
        }
        .checkbox-group label {
            cursor: pointer; color: #475569; line-height: 1.5;
        }

        /* --- CONTEXT MENU --- */
        #context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 10002;
            display: none;
        }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .context-menu-item:hover {
            background: var(--accent-light);
        }

        /* --- DASHBOARD & TABS --- */
        #top-area {
            background: white; border-bottom: 1px solid var(--border);
            flex-shrink: 0; z-index: 50; display: none; flex-direction: column;
        }

        #dashboard {
            padding: 8px 10px; display: flex; justify-content: space-between;
            align-items: stretch; height: auto; min-height: 65px; gap: 5px;
        }

        #tab-container {
            display: flex; gap: 5px; padding: 0 10px 10px 10px; overflow-x: auto;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        #tab-container::-webkit-scrollbar { display: none; }

        .tab-btn {
            background: var(--tab-inactive-bg); color: #64748b; border: none;
            padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            white-space: nowrap; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;
            position: relative;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .tab-btn.active { 
            background: var(--tab-active-bg); color: white; 
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3); 
        }
        .tab-btn.incomplete {
            background: var(--tab-incomplete-bg);
            border: 2px dashed var(--warning);
            animation: pulse 2s ease-in-out infinite;
        }
        .tab-btn.incomplete::after {
            content: "‚ö†Ô∏è";
            font-size: 0.9rem;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .tab-add {
            background: white; border: 1px dashed var(--accent); color: var(--accent);
            width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
        }

        .stat-group { display: flex; gap: 8px; width: 100%; justify-content: space-between; }
        .stat-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px;
        }
        .stat-title { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 800; color: #64748b; margin-bottom: 4px; text-align: center; }
        .stat-values { 
            font-family: 'Roboto Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--primary); 
            display: flex; flex-direction: column; align-items: center; line-height: 1.2;
        }
        .val-unit { font-size: 0.7rem; color: #94a3b8; font-weight: 500; margin-left: 2px; }
        
        .txt-success { color: var(--success); }
        .txt-accent { color: var(--accent); }

        /* --- TABLO ALANI --- */
        #table-container {
            flex: 1; overflow: auto; position: relative; padding: 0; background: #e2e8f0;
            -webkit-overflow-scrolling: touch;
        }
        table { border-collapse: separate; border-spacing: 0; width: 100%; background: white; padding-bottom: 20px; }
        th, td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 8px; text-align: center; vertical-align: middle; background: white; }

        thead th { position: sticky; top: 0; z-index: 10; background: var(--header-bg); color: var(--primary); font-weight: 700; height: 40px; box-shadow: 0 1px 0 var(--border); }
        tbody th { position: sticky; left: 0; z-index: 20; background: var(--header-bg); color: var(--primary); font-weight: 700; min-width: 60px; box-shadow: 1px 0 0 var(--border); }
        thead th:first-child { position: sticky; left: 0; top: 0; z-index: 30; background: var(--primary); color: white; border-right: 1px solid #334155; border-bottom: 1px solid #334155; }

        .cell-controls { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-ctrl { width: 35px; height: 35px; border-radius: 8px; border: 1px solid var(--border); background: #f8fafc; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: 0.1s; user-select: none; font-size: 1.2rem; }
        .btn-ctrl:active { background: #e2e8f0; transform: scale(0.95); }
        .btn-minus { color: var(--danger); }
        .btn-plus { color: var(--success); }
        .btn-ctrl:disabled { opacity: 0.3; cursor: not-allowed; }

        .cell-info { display: flex; flex-direction: column; min-width: 70px; }
        .qty-text { font-family: 'Roboto Mono', monospace; font-size: 0.9rem; font-weight: 600; }
        .qty-shipped { color: var(--success); }
        .qty-slash { color: #cbd5e1; font-weight: 400; font-size: 0.8rem; }
        .qty-total { color: #94a3b8; font-size: 0.8rem; }
        .vol-text { font-size: 0.65rem; color: #94a3b8; margin-top: 2px; }
        .active-row .vol-text { color: var(--success); font-weight: 700; }

        td.has-data { background: #ffffff; }
        td.empty-data { background: #f8fafc; color: #cbd5e1; font-size: 0.8rem; }
        td.active-shipment { background: #f0fdf4; }

        /* --- FOOTER --- */
        #footer {
            background: white; border-top: 1px solid var(--border); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; height: auto; min-height: 70px;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 100;
        }
        .btn-finish {
            background: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 0.9rem;
            transition: 0.3s;
        }
        .btn-finish.warning {
            background: var(--warning);
        }
        .btn-finish:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        .btn-reset {
            background: #f1f5f9; color: #64748b; border: 1px solid var(--border); border-radius: 8px;
            font-size: 0.85rem; padding: 10px 15px; cursor: pointer; font-weight: 600;
        }
        .btn-finish:hover:not(:disabled) { transform: translateY(-2px); }

        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7);
            z-index: 10000; display: none; align-items: center; justify-content: center; color: white; font-weight: 600; flex-direction: column; gap: 15px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div id="app-header" style="display: none;">
        <span id="app-title">üå≤ Tomruk Stok Pro</span>
    </div>

    <div id="cloud-modal">
        <div class="cloud-content">
            <div class="cloud-header">
                <div class="cloud-title">
                    <button id="cloud-back-btn" class="btn-back-cloud" onclick="handleCloudBack()">‚¨ÖÔ∏è Geri</button>
                    <span id="cloud-title-text">Dosyalar</span>
                </div>
                <button class="btn-close" onclick="closeCloudMenu()">√ó</button>
            </div>
            
            <div id="cloud-search-area">
                <input type="text" id="search-input" placeholder="üîç Ara..." inputmode="text">
            </div>

            <div id="cloud-list" class="cloud-body"></div>
            <div id="cloud-loader" class="cloud-loading">
                <div class="spinner" style="border-color: #3b82f6; border-top-color: transparent; margin: 0 auto 10px auto;"></div>
                Veriler Getiriliyor...
            </div>
        </div>
    </div>

    <div id="truck-info-modal">
        <div class="truck-info-content">
            <div class="truck-info-title" id="truck-modal-title">üöõ Ara√ß Bilgileri</div>
            <div class="input-group">
                <label class="input-label">Plaka / ƒ∞sim *</label>
                <input type="text" id="input-plate" class="input-field" placeholder="34 ABC 123 veya Kamyon-1" maxlength="50">
            </div>
            <div class="input-group">
                <label class="input-label">≈ûof√∂r Adƒ± Soyadƒ± *</label>
                <input type="text" id="input-driver" class="input-field" placeholder="Ahmet Yƒ±lmaz" maxlength="50">
            </div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="cancelTruckInfo()">ƒ∞ptal</button>
                <button class="btn-save" onclick="saveTruckInfo()">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="export-modal">
        <div class="export-content">
            <div class="export-title">üì¶ Kalan Stok Sayfasƒ±</div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="export-remaining-check">
                <label for="export-remaining-check">
                    Kalan envanter i√ßin Plaka ve ≈ûof√∂r bilgisi eklemek ister misin?
                </label>
            </div>
            
            <div id="remaining-input-group" style="display: none;">
                <div class="input-group">
                    <label class="input-label">Plaka (Sayfa Adƒ± Olacak)</label>
                    <input type="text" 
                           id="export-remaining-plate" 
                           class="input-field" 
                           placeholder="34 ABC 123" 
                           maxlength="50">
                </div>
                <div class="input-group">
                    <label class="input-label">≈ûof√∂r Adƒ±</label>
                    <input type="text" 
                           id="export-remaining-driver" 
                           class="input-field" 
                           placeholder="Ahmet Yƒ±lmaz" 
                           maxlength="50">
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeExportModal()">ƒ∞ptal</button>
                <button class="btn-save" onclick="confirmExport()">‚úÖ Raporu Olu≈ütur</button>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <div class="context-menu-item" onclick="editTruckFromMenu()">
            <span>‚úèÔ∏è</span>
            <span>Bilgileri D√ºzenle</span>
        </div>
    </div>
    <div id="upload-overlay">
        <div class="upload-box">
            <div style="font-size: 3rem; margin-bottom: 10px;">üå≤</div>
            <h2 style="color: var(--primary); margin-bottom: 5px;">Tomruk Stok Pro</h2>
            <div style="font-size:0.8rem; color: var(--accent); font-weight:600; margin-bottom: 10px;">T√ºrk M√ºhendisliƒüinin Dijital G√ºc√º v3.7</div>
            
            <p style="color: #64748b; font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px;">
                <strong>√ñzkan KANBUR</strong><br>
                Orman End√ºstri M√ºhendisi
            </p>

            <button id="btn-restore" onclick="restoreSession()">
                ‚èÆÔ∏è √ñnceki √áalƒ±≈ümaya Devam Et
            </button>

            <button class="btn-upload-cloud" onclick="openCloudMenu()">
                ‚òÅÔ∏è Buluttan Y√ºkle (Drive)
            </button>

            <label class="btn-upload-local">
                üìÇ Telefondan/PC'den Se√ß
                <input type="file" id="file-input" hidden accept=".xlsx, .xls" onchange="handleFileUpload(event)">
            </label>
            
            <div id="error-box" class="error-msg"></div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">ƒ∞≈ülem Yapƒ±lƒ±yor...</div>
    </div>

    <div id="top-area">
        <div id="dashboard">
            <div class="stat-group">
                <div class="stat-item">
                    <div class="stat-title">ANA STOK</div>
                    <div class="stat-values">
                        <div><span id="lbl-start-qty">0</span> <span class="val-unit">Ad</span></div>
                        <div><span id="lbl-start-m3">0.000</span> <span class="val-unit">m¬≥</span></div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-title txt-success">BU ARA√á</div>
                    <div class="stat-values txt-success">
                        <div><span id="lbl-truck-qty">0</span> <span class="val-unit">Ad</span></div>
                        <div><span id="lbl-truck-m3">0.000</span> <span class="val-unit">m¬≥</span></div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-title txt-accent">KALAN</div>
                    <div class="stat-values txt-accent">
                        <div><span id="lbl-remain-qty">0</span> <span class="val-unit">Ad</span></div>
                        <div><span id="lbl-remain-m3">0.000</span> <span class="val-unit">m¬≥</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-container"></div>
    </div>

    <div id="table-container">
        <table id="matrix-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="footer" style="display: none;">
        <button class="btn-reset" onclick="resetApp()">‚Ü∫ Yeni</button>
        <button class="btn-finish" id="btn-export" onclick="openExportModal()">üíæ Raporu ƒ∞ndir</button>
    </div>

    <script>
        // ==========================================
        // AYARLAR
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbygtPZZ5zTatTcVtCi3OwVhYKY7bChGspQlEbpwOU3lUSJH7RHJVe0xkWOv2rUjVZZF/exec"; 

        // Global Deƒüi≈ükenler
        let rawFileBuffer = null; 
        let inventory = [];
        let trucks = []; 
        let activeTruckIndex = 0;
        let istifNo = "";
        let editingTruckIndex = -1;
        let contextMenuTruckIndex = -1;
        
        // Klas√∂r Gezinti Ge√ßmi≈üi
        let folderHistory = []; 

        window.addEventListener('DOMContentLoaded', () => {
            checkPreviousSession();
            
            document.getElementById('search-input').addEventListener('input', function(e) {
                const searchText = e.target.value.toLowerCase();
                const items = document.querySelectorAll('.cloud-item');
                
                items.forEach(item => {
                    const text = item.innerText.toLowerCase();
                    if(text.includes(searchText)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            document.addEventListener('click', () => {
                document.getElementById('context-menu').style.display = 'none';
            });

            // Checkbox listener
            document.getElementById('export-remaining-check').addEventListener('change', function(e) {
                document.getElementById('remaining-input-group').style.display = e.target.checked ? 'block' : 'none';
            });
        });

        // ==========================================
        // CLOUD / DRIVE ƒ∞≈ûLEMLERƒ∞ (G√úNCELLENDƒ∞)
        // ==========================================
        function openCloudMenu() {
            if(SCRIPT_URL.includes("BURAYA_")) {
                alert("L√ºtfen kodun i√ßindeki SCRIPT_URL kƒ±smƒ±na kendi Apps Script adresini yapƒ±≈ütƒ±r.");
                return;
            }
            document.getElementById('cloud-modal').style.display = 'flex';
            folderHistory = []; 
            // Ba≈ülangƒ±√ßta ana dizini (null g√∂ndererek) √ßaƒüƒ±rƒ±yoruz
            fetchFolderContents(null, "Ana Dizin", false);
        }

        function closeCloudMenu() {
            document.getElementById('cloud-modal').style.display = 'none';
            folderHistory = [];
        }

        function showCloudLoading(show) {
            document.getElementById('cloud-loader').style.display = show ? 'block' : 'none';
            document.getElementById('cloud-list').style.display = show ? 'none' : 'block';
        }

        function handleCloudBack() {
            if (folderHistory.length > 0) {
                folderHistory.pop(); // ≈ûu anki klas√∂r√º √ßƒ±kar (en sondaki)
                
                if (folderHistory.length === 0) {
                    // Ge√ßmi≈ü bo≈üaldƒ±ysa ana dizine d√∂n
                    fetchFolderContents(null, "Ana Dizin", false);
                } else {
                    // Bir √∂nceki klas√∂re d√∂n
                    const prevFolder = folderHistory[folderHistory.length - 1];
                    fetchFolderContents(prevFolder.id, prevFolder.name, false); 
                }
            } else {
                fetchFolderContents(null, "Ana Dizin", false);
            }
        }

        // Tek ve birle≈üik fonksiyon: Hem klas√∂rleri hem dosyalarƒ± getirir
        async function fetchFolderContents(folderId, folderName, pushToHistory = true) {
            showCloudLoading(true);
            
            // UI G√ºncellemeleri
            document.getElementById('cloud-title-text').innerText = folderName || "Dosyalar";
            document.getElementById('search-input').value = '';
            
            // Ana dizinde (folderId yok veya history bo≈ü) geri tu≈üunu gizle
            if (!folderId || (pushToHistory && folderHistory.length === 0)) {
                document.getElementById('cloud-back-btn').style.display = 'none';
            } else {
                document.getElementById('cloud-back-btn').style.display = 'inline-block';
            }

            // Ge√ßmi≈üe ekle
            if (pushToHistory && folderId) {
                // Eƒüer zaten son eleman bu ise ekleme (√ßift tƒ±klama korumasƒ±)
                if(folderHistory.length === 0 || folderHistory[folderHistory.length-1].id !== folderId) {
                    folderHistory.push({id: folderId, name: folderName});
                }
            }

            try {
                // API isteƒüi: folderId varsa g√∂nder, yoksa null (Apps Script'te Master ID kullanƒ±lƒ±r)
                let url = `${SCRIPT_URL}?action=getFolderContents`;
                if (folderId) {
                    url += `&folderId=${folderId}`;
                }

                const response = await fetch(url);
                const items = await response.json();
                
                if(items.error) {
                    throw new Error(items.error);
                }
                
                renderCloudList(items);
                
                // Eƒüer ana dizine d√∂nd√ºysek ve history bo≈ü deƒüilse (geri tu≈üuyla geldiysek), history'i temizle
                if (!folderId && !pushToHistory) {
                    folderHistory = [];
                    document.getElementById('cloud-back-btn').style.display = 'none';
                }

            } catch (error) {
                alert("ƒ∞√ßerik alƒ±namadƒ±: " + error.message);
                // Hata durumunda y√ºkleniyor ekranƒ±nƒ± kapat
                showCloudLoading(false);
                return;
            }
            showCloudLoading(false);
        }

        function renderCloudList(items) {
            const container = document.getElementById('cloud-list');
            container.innerHTML = '';
            
            if(!items || items.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">Klas√∂r bo≈ü.</div>';
                return;
            }

            // SIRALAMA: √ñnce Klas√∂rler, Sonra Dosyalar. Kendi i√ßlerinde Alfabetik.
            items.sort((a, b) => {
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;
                return a.name.localeCompare(b.name);
            });

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cloud-item';
                
                if (item.type === 'folder') {
                    // KLAS√ñR G√ñR√úN√úM√ú
                    div.innerHTML = `<span class="cloud-icon icon-folder">üìÅ</span> <span class="cloud-text">${item.name}</span>`;
                    div.onclick = () => fetchFolderContents(item.id, item.name, true);
                } else {
                    // EXCEL DOSYASI G√ñR√úN√úM√ú
                    div.innerHTML = `<span class="cloud-icon icon-file">üìä</span> <span class="cloud-text">${item.name}</span>`;
                    div.onclick = () => downloadAndProcessDriveFile(item.id, item.name);
                }
                container.appendChild(div);
            });
        }

        async function downloadAndProcessDriveFile(fileId, fileName) {
            showCloudLoading(true);
            document.getElementById('cloud-title-text').innerText = "ƒ∞ndiriliyor...";
            document.getElementById('cloud-search-area').style.display = 'none';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getFileContent&fileId=${fileId}`);
                const jsonText = await response.text(); 

                if (jsonText.startsWith("<!DOCTYPE html>")) {
                    throw new Error("Google API hatasƒ±. Hesabƒ±nƒ±zƒ±n a√ßƒ±k olduƒüundan emin olun.");
                }

                const result = JSON.parse(jsonText);

                if (result.error) throw new Error(result.error);
                if (!result.data) throw new Error("Dosya bo≈ü.");
                
                let base64 = result.data.replace(/\s/g, ''); 
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                processExcelBuffer(bytes.buffer);
                closeCloudMenu();

            } catch (error) {
                console.error(error);
                alert("Hata: " + error.message);
            }
            showCloudLoading(false);
        }

        // ==========================================
        // STANDART DOSYA ƒ∞≈ûLEME VE UI FONKSƒ∞YONLARI (DEƒûƒ∞≈ûMEDƒ∞)
        // ==========================================
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => processExcelBuffer(e.target.result);
            reader.readAsArrayBuffer(file);
        }

        function processExcelBuffer(buffer) {
            try {
                rawFileBuffer = buffer; 
                const data = new Uint8Array(rawFileBuffer);
                const wb = XLSX.read(data, {type: 'array'});
                const sheet = wb.Sheets[wb.SheetNames[0]];
                
                const d5Cell = sheet['D5'];
                istifNo = (d5Cell && d5Cell.v) ? String(d5Cell.v).trim() : "Istif_" + Date.now();
                
                const result = parseExcelSmart(sheet);
                if(result.success) {
                    inventory = result.data;
                    trucks = [{ id: Date.now(), tempName: "Ara√ß 1", plate: "", driver: "", shipments: {} }];
                    activeTruckIndex = 0;
                    initApp();
                } else {
                    showError(result.message);
                }
            } catch (err) {
                showError("Excel okunamadƒ±: " + err.message);
            }
        }

        function initApp() {
            document.getElementById('upload-overlay').style.display = 'none';
            document.getElementById('app-header').style.display = 'flex';
            document.getElementById('top-area').style.display = 'flex';
            document.getElementById('footer').style.display = 'flex';
            document.getElementById('app-title').innerText = `üå≤ Tomruk Stok Pro - ƒ∞stif: ${istifNo}`;
            renderTabs();
            renderTable();
            updateDashboard();
            updateExportButton();
        }

        function showTruckInfoModal(truckIndex = -1) {
            editingTruckIndex = truckIndex;
            const truck = truckIndex >= 0 ? trucks[truckIndex] : null;
            document.getElementById('truck-modal-title').innerText = truck ? `üöõ ${truck.tempName || 'Ara√ß'} Bilgileri` : 'üöõ Ara√ß Bilgileri';
            document.getElementById('input-plate').value = truck ? (truck.plate || '') : '';
            document.getElementById('input-driver').value = truck ? (truck.driver || '') : '';
            document.getElementById('input-plate').classList.remove('error');
            document.getElementById('input-driver').classList.remove('error');
            document.getElementById('truck-info-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('input-plate').focus(), 300);
        }

        function cancelTruckInfo() {
            document.getElementById('truck-info-modal').style.display = 'none';
            editingTruckIndex = -1;
        }

        function saveTruckInfo() {
            const plate = document.getElementById('input-plate').value.trim();
            const driver = document.getElementById('input-driver').value.trim();
            if(!plate || !driver) { alert("L√ºtfen t√ºm alanlarƒ± doldurun!"); return; }
            if(editingTruckIndex >= 0) {
                trucks[editingTruckIndex].plate = plate;
                trucks[editingTruckIndex].driver = driver;
            }
            document.getElementById('truck-info-modal').style.display = 'none';
            editingTruckIndex = -1;
            renderTabs();
            updateExportButton();
            saveSession();
        }

        function openExportModal() {
            const hasAnyShipment = trucks.some(t => Object.values(t.shipments).some(v => v > 0));
            if(!hasAnyShipment) { alert("Hen√ºz hi√ßbir araca y√ºkleme yapƒ±lmadƒ±."); return; }
            const incompleteCount = trucks.filter(t => !t.plate || !t.driver).length;
            if(incompleteCount > 0) { alert(`‚ö†Ô∏è ${incompleteCount} aracƒ±n bilgileri eksik!`); return; }
            document.getElementById('export-remaining-check').checked = false;
            document.getElementById('remaining-input-group').style.display = 'none';
            document.getElementById('export-remaining-plate').value = '';
            document.getElementById('export-remaining-driver').value = '';
            document.getElementById('export-modal').style.display = 'flex';
        }

        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }

        function confirmExport() {
            let remPlate = "", remDriver = "";
            if(document.getElementById('export-remaining-check').checked) {
                remPlate = document.getElementById('export-remaining-plate').value.trim();
                remDriver = document.getElementById('export-remaining-driver').value.trim();
            }
            closeExportModal();
            exportDataSafe(remPlate, remDriver);
        }

        function showContextMenu(e, truckIndex) {
            if (e.preventDefault) { e.preventDefault(); e.stopPropagation(); }
            contextMenuTruckIndex = truckIndex;
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function editTruckFromMenu() {
            document.getElementById('context-menu').style.display = 'none';
            if(contextMenuTruckIndex >= 0) showTruckInfoModal(contextMenuTruckIndex);
        }

        function renderTabs() {
            const container = document.getElementById('tab-container');
            container.innerHTML = '';
            trucks.forEach((truck, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === activeTruckIndex ? 'active' : ''}`;
                if(!truck.plate || !truck.driver) btn.classList.add('incomplete');
                btn.innerHTML = `üöõ ${truck.plate || truck.tempName || `Ara√ß ${index + 1}`}`;
                btn.onclick = () => switchTab(index);
                btn.addEventListener('contextmenu', (e) => showContextMenu(e, index));
                let pressTimer;
                btn.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => showContextMenu(e.touches[0], index), 500); }, { passive: true });
                btn.addEventListener('touchend', () => clearTimeout(pressTimer));
                btn.addEventListener('touchmove', () => clearTimeout(pressTimer));
                container.appendChild(btn);
            });
            const addBtn = document.createElement('button');
            addBtn.className = 'tab-add tab-btn';
            addBtn.innerHTML = '+';
            addBtn.onclick = addNewTruck;
            container.appendChild(addBtn);
        }

        function switchTab(index) {
            activeTruckIndex = index;
            renderTabs();
            renderTable(); 
            updateDashboard();
        }

        function addNewTruck() {
            const currentTruck = trucks[activeTruckIndex];
            if(!currentTruck.plate || !currentTruck.driver) {
                showTruckInfoModal(activeTruckIndex);
                const originalSave = saveTruckInfo;
                saveTruckInfo = function() {
                    originalSave();
                    trucks.push({ id: Date.now(), tempName: `Ara√ß ${trucks.length + 1}`, plate: "", driver: "", shipments: {} });
                    switchTab(trucks.length - 1);
                    saveSession();
                    saveTruckInfo = originalSave;
                };
            } else {
                trucks.push({ id: Date.now(), tempName: `Ara√ß ${trucks.length + 1}`, plate: "", driver: "", shipments: {} });
                switchTab(trucks.length - 1);
                saveSession();
            }
        }

        function updateExportButton() {
            const btn = document.getElementById('btn-export');
            const incomplete = trucks.filter(t => !t.plate || !t.driver).length;
            btn.classList.toggle('warning', incomplete > 0);
            btn.innerHTML = incomplete > 0 ? `üíæ Raporu ƒ∞ndir (${incomplete} ara√ß eksik!)` : 'üíæ Raporu ƒ∞ndir';
        }

        function renderTable() {
            const thead = document.querySelector('#matrix-table thead');
            const tbody = document.querySelector('#matrix-table tbody');
            const lengths = [...new Set(inventory.map(i => i.length))].sort((a,b) => a - b);
            const diameters = [...new Set(inventory.map(i => i.diameter))].sort((a,b) => a - b);

            let headHTML = '<tr><th>√áAP \\ BOY</th>';
            lengths.forEach(l => headHTML += `<th>${l}</th>`);
            headHTML += '</tr>';
            thead.innerHTML = headHTML;

            let bodyHTML = '';
            diameters.forEach(dia => {
                const itemsInRow = inventory.filter(i => i.diameter === dia);
                if(itemsInRow.length === 0) return;
                let rowHTML = `<tr><th>${dia}</th>`;
                lengths.forEach(len => {
                    const item = itemsInRow.find(i => i.length === len);
                    if(item) {
                        let prev = 0;
                        for(let i=0; i < activeTruckIndex; i++) prev += (trucks[i].shipments[item.id] || 0);
                        const limit = item.totalQty - prev;
                        const curr = trucks[activeTruckIndex].shipments[item.id] || 0;
                        const vol = curr * (item.totalVol / item.totalQty);
                        rowHTML += `
                            <td id="td-${item.id}" class="has-data ${curr > 0 ? 'active-shipment' : ''}">
                                <div class="cell-controls">
                                    <button class="btn-ctrl btn-minus" onclick="changeQty('${item.id}', -1)" ${curr === 0 ? 'disabled' : ''}>‚àí</button>
                                    <div class="cell-info">
                                        <div class="qty-text"><span class="qty-shipped">${curr}</span><span class="qty-slash">/</span><span class="qty-total">${limit}</span></div>
                                        <div class="vol-text">${vol.toFixed(3)} m¬≥</div>
                                    </div>
                                    <button class="btn-ctrl btn-plus" onclick="changeQty('${item.id}', 1)" ${curr >= limit ? 'disabled' : ''}>+</button>
                                </div>
                            </td>`;
                    } else {
                        rowHTML += `<td class="empty-data">-</td>`;
                    }
                });
                bodyHTML += rowHTML + '</tr>';
            });
            tbody.innerHTML = bodyHTML;
        }

        function changeQty(itemId, delta) {
            const item = inventory.find(i => i.id === itemId);
            if(!item) return;
            const truck = trucks[activeTruckIndex];
            const curr = truck.shipments[itemId] || 0;
            let prev = 0;
            for(let i=0; i < activeTruckIndex; i++) prev += (trucks[i].shipments[itemId] || 0);
            const limit = item.totalQty - prev;
            
            if(delta === 1 && curr < limit) truck.shipments[itemId] = curr + 1;
            else if(delta === -1 && curr > 0) truck.shipments[itemId] = curr - 1;
            else return;
            
            saveSession();
            renderTable(); 
            updateDashboard();
        }

        function updateDashboard() {
            let startQ=0, startV=0, truckQ=0, truckV=0, endQ=0, endV=0;
            inventory.forEach(item => {
                const uVol = item.totalVol / item.totalQty;
                let prev = 0;
                for(let i=0; i < activeTruckIndex; i++) prev += (trucks[i].shipments[item.id] || 0);
                const sStock = item.totalQty - prev;
                const curr = trucks[activeTruckIndex].shipments[item.id] || 0;
                startQ += sStock; startV += sStock*uVol;
                truckQ += curr; truckV += curr*uVol;
                endQ += (sStock-curr); endV += (sStock-curr)*uVol;
            });
            document.getElementById('lbl-start-qty').innerText = startQ;
            document.getElementById('lbl-start-m3').innerText = startV.toFixed(3);
            document.getElementById('lbl-truck-qty').innerText = truckQ;
            document.getElementById('lbl-truck-m3').innerText = truckV.toFixed(3);
            document.getElementById('lbl-remain-qty').innerText = endQ;
            document.getElementById('lbl-remain-m3').innerText = endV.toFixed(3);
        }

        function parseExcelSmart(sheet) {
            if(!sheet['!ref']) return {success:false, message:"Dosya bo≈ü."};
            const range = XLSX.utils.decode_range(sheet['!ref']);
            let adetRow = -1;
            for(let r=0; r<=Math.min(30, range.e.r); r++) {
                let cnt = 0;
                for(let c=0; c<=range.e.c; c++) {
                    const cell = sheet[XLSX.utils.encode_cell({r,c})];
                    if(cell && String(cell.v).toUpperCase().includes('ADET')) cnt++;
                }
                if(cnt > 1) { adetRow = r; break; }
            }
            if(adetRow === -1) return {success:false, message: "'ADET' satƒ±rƒ± bulunamadƒ±."};
            const colToLength = {};
            for(let c=0; c<=range.e.c; c++) {
                const cell = sheet[XLSX.utils.encode_cell({r: adetRow, c})];
                if(cell && String(cell.v).toUpperCase().includes('ADET')) {
                    const lCell = sheet[XLSX.utils.encode_cell({r: adetRow-1, c})];
                    if(lCell && lCell.v) colToLength[c] = lCell.v;
                }
            }
            let diaCol = 0, maxSeq = 0;
            for(let c=0; c<=3; c++) {
                let seq = 0;
                for(let r=adetRow+1; r<=Math.min(adetRow+10, range.e.r); r++) {
                    const v = sheet[XLSX.utils.encode_cell({r,c})];
                    if(v && !isNaN(v.v) && v.v > 5) seq++;
                }
                if(seq > maxSeq) { maxSeq = seq; diaCol = c; }
            }
            const data = [];
            for(let r=adetRow+1; r<=range.e.r; r++) {
                const dCell = sheet[XLSX.utils.encode_cell({r, c:diaCol})];
                if(dCell && !isNaN(dCell.v)) {
                    for(let cStr in colToLength) {
                        const c = parseInt(cStr);
                        const qCell = sheet[XLSX.utils.encode_cell({r,c})];
                        const vCell = sheet[XLSX.utils.encode_cell({r,c:c+1})];
                        if(qCell && qCell.v > 0) {
                            const vol = (vCell && !isNaN(vCell.v)) ? parseFloat(vCell.v)/1000 : 0;
                            data.push({ id: XLSX.utils.encode_cell({r,c}), diameter: dCell.v, length: colToLength[c], totalQty: parseInt(qCell.v), totalVol: vol, qtyAddr: XLSX.utils.encode_cell({r,c}) });
                        }
                    }
                }
            }
            return data.length ? {success:true, data} : {success:false, message:"Veri bulunamadƒ±."};
        }

        async function exportDataSafe(rPlate, rDriver) {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Rapor Hazƒ±rlanƒ±yor...";
            setTimeout(async () => {
                try {
                    const wb = await XlsxPopulate.fromDataAsync(rawFileBuffer);
                    const sheet = wb.sheet(0);
                    trucks.forEach((t, i) => processSheet(wb.cloneSheet(sheet, (t.plate||t.tempName).substring(0,31).replace(/[:\/\?\*\[\]]/g,'_')), 'truck', i));
                    const remSheet = wb.cloneSheet(sheet, (rPlate||"Kalan_Stok").substring(0,31).replace(/[:\/\?\*\[\]]/g,'_'));
                    processSheet(remSheet, 'remaining', null, {plate:rPlate, driver:rDriver});
                    sheet.name("Sablon").hidden(true);
                    const blob = await wb.outputAsync();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url; a.download = `${istifNo}.xlsx`;
                    document.body.appendChild(a); a.click();
                    document.body.removeChild(a);
                    document.getElementById('loading-overlay').style.display = 'none';
                } catch (e) { alert("Hata: " + e.message); document.getElementById('loading-overlay').style.display = 'none'; }
            }, 500);
        }

        function processSheet(sheet, mode, truckIndex, extra={}) {
            const usedRows = new Set();
            const lens = [...new Set(inventory.map(i => i.length))].sort((a,b)=>a-b);
            const cols = [3,5,7,9,11,13,15];
            const lenMap = {};
            lens.forEach((l,i) => lenMap[l] = (i<7) ? cols[i] : 15+((i-6)*2));
            
            cols.forEach(c => sheet.row(7).cell(c).value(null));
            for(let r=9; r<=97; r++) for(let c=3; c<=17; c+=2) sheet.row(r).cell(c).value(null);
            
            lens.forEach(l => { if(lenMap[l]) sheet.row(7).cell(lenMap[l]).value(l); });
            
            inventory.forEach(item => {
                let q = 0;
                if(mode==='truck') q = trucks[truckIndex].shipments[item.id]||0;
                else {
                    let s = 0; trucks.forEach(t => s+=(t.shipments[item.id]||0));
                    q = item.totalQty - s;
                }
                const r = parseInt(item.qtyAddr.match(/\d+/)[0]);
                const c = lenMap[item.length];
                if(c && q>0) { sheet.row(r).cell(c).value(q).style("numberFormat","0"); usedRows.add(r); }
            });
            
            for(let r=9; r<=97; r++) {
                if(!usedRows.has(r)) sheet.row(r).hidden(true);
                else { sheet.row(r).hidden(false); for(let c=3; c<=17; c+=2) if(sheet.row(r).cell(c).value()==null) sheet.row(r).cell(c).style("numberFormat","0"); }
            }
            if(mode==='truck') { sheet.cell("J105").value(trucks[truckIndex].plate); sheet.cell("J106").value(trucks[truckIndex].driver); }
            else { if(extra.plate) sheet.cell("J105").value(extra.plate); if(extra.driver) sheet.cell("J106").value(extra.driver); }
            sheet.workbook().definedName("Print_Area", `'${sheet.name()}'!$A$1:$T$104`);
        }

        function saveSession() {
            if(!rawFileBuffer) return;
            localStorage.setItem('tsp_v37_file', arrayBufferToBase64(rawFileBuffer));
            localStorage.setItem('tsp_v37_istif', istifNo);
            localStorage.setItem('tsp_v37_data', JSON.stringify({inventory, trucks, activeTruckIndex}));
        }

        function restoreSession() {
            const d = localStorage.getItem('tsp_v37_data');
            const f = localStorage.getItem('tsp_v37_file');
            if(!d || !f) return;
            rawFileBuffer = base64ToArrayBuffer(f);
            const p = JSON.parse(d);
            inventory = p.inventory; trucks = p.trucks; activeTruckIndex = p.activeTruckIndex || 0;
            istifNo = localStorage.getItem('tsp_v37_istif') || "Istif_Auto";
            initApp();
        }

        function checkPreviousSession() { if(localStorage.getItem('tsp_v37_data')) document.getElementById('btn-restore').style.display = 'flex'; }
        
        function resetApp() {
            if(!confirm("Her ≈üey silinecek?")) return;
            localStorage.removeItem('tsp_v37_file'); localStorage.removeItem('tsp_v37_data'); localStorage.removeItem('tsp_v37_istif');
            location.reload();
        }

        function arrayBufferToBase64(b) { let s=''; const u=new Uint8Array(b); for(let i=0; i<u.length; i++) s+=String.fromCharCode(u[i]); return window.btoa(s); }
        function base64ToArrayBuffer(b) { const s=window.atob(b); const u=new Uint8Array(s.length); for(let i=0; i<s.length; i++) u[i]=s.charCodeAt(i); return u.buffer; }
        function showError(m) { const b=document.getElementById('error-box'); b.innerText=m; b.style.display='block'; }
    </script>
</body>
</html>
